<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:GuyOllamaAI.ViewModels"
        xmlns:views="using:GuyOllamaAI.Views"
        x:Class="GuyOllamaAI.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        Title="GuyOllamaAI"
        Width="1000" Height="700"
        MinWidth="800" MinHeight="500"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}">

    <Grid ColumnDefinitions="250, *">
        <!-- Sidebar -->
        <Border Grid.Column="0"
                Background="{DynamicResource SurfaceBrush}"
                Padding="16">
            <Grid RowDefinitions="Auto, Auto, *, Auto">
                <!-- App Header -->
                <StackPanel Grid.Row="0" Spacing="4" Margin="0,0,0,16">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Border Width="40" Height="40"
                                CornerRadius="10"
                                Background="{DynamicResource PrimaryBrush}">
                            <TextBlock Text="G"
                                       FontSize="22"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />
                        </Border>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="GuyOllamaAI"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}" />
                            <TextBlock Text="Local AI Chat"
                                       FontSize="11"
                                       Foreground="{DynamicResource TextSecondaryBrush}" />
                        </StackPanel>
                    </StackPanel>
                </StackPanel>

                <!-- New Chat Button -->
                <Button Grid.Row="1"
                        Classes="primary"
                        HorizontalAlignment="Stretch"
                        Margin="0,0,0,16"
                        Command="{Binding NewChatCommand}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="+" FontSize="18" FontWeight="Bold" />
                        <TextBlock Text="New Chat" VerticalAlignment="Center" />
                    </StackPanel>
                </Button>

                <!-- Chat History -->
                <ScrollViewer Grid.Row="2">
                    <ItemsControl ItemsSource="{Binding ChatHistory}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Classes="secondary"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Left"
                                        Margin="0,2"
                                        Command="{Binding $parent[Window].((vm:MainViewModel)DataContext).SelectChatCommand}"
                                        CommandParameter="{Binding}">
                                    <TextBlock Text="{Binding Title}"
                                               TextTrimming="CharacterEllipsis"
                                               MaxWidth="180" />
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Bottom Actions -->
                <StackPanel Grid.Row="3" Spacing="8">
                    <Separator />

                    <!-- Connection Status -->
                    <Border Background="{DynamicResource CardBrush}"
                            CornerRadius="8"
                            Padding="12,8">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Ellipse Width="8" Height="8"
                                     Fill="{Binding ConnectionStatusColor}" />
                            <TextBlock Text="{Binding ConnectionStatus}"
                                       Classes="caption"
                                       VerticalAlignment="Center" />
                        </StackPanel>
                    </Border>

                    <!-- Settings & Info Buttons -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Classes="secondary"
                                HorizontalAlignment="Stretch"
                                Command="{Binding ShowSettingsCommand}"
                                ToolTip.Tip="Settings">
                            <TextBlock Text="Settings" FontSize="12" />
                        </Button>
                        <Button Classes="secondary"
                                HorizontalAlignment="Stretch"
                                Command="{Binding ShowInfoCommand}"
                                ToolTip.Tip="How to get Ollama">
                            <TextBlock Text="Get Ollama" FontSize="12" />
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Chat Area -->
        <Grid Grid.Column="1" RowDefinitions="Auto, *, Auto">
            <!-- Top Bar -->
            <Border Grid.Row="0"
                    Background="{DynamicResource SurfaceBrush}"
                    Padding="20,12"
                    BorderThickness="0,0,0,1"
                    BorderBrush="{DynamicResource CardBrush}">
                <Grid ColumnDefinitions="*, Auto">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <TextBlock Text="{Binding CurrentChatTitle}"
                                   Classes="heading"
                                   VerticalAlignment="Center" />
                    </StackPanel>

                    <!-- Model Selector -->
                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="8">
                        <TextBlock Text="Model:"
                                   Classes="caption"
                                   VerticalAlignment="Center" />
                        <ComboBox ItemsSource="{Binding AvailableModels}"
                                  SelectedItem="{Binding SelectedModel}"
                                  MinWidth="150"
                                  IsEnabled="{Binding !IsLoading}" />
                        <Button Classes="icon"
                                Command="{Binding RefreshModelsCommand}"
                                ToolTip.Tip="Refresh models">
                            <TextBlock Text="Refresh" FontSize="11" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Messages Area -->
            <ScrollViewer Grid.Row="1"
                          Name="MessagesScrollViewer"
                          Padding="20">
                <ItemsControl ItemsSource="{Binding Messages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Classes="message-card"
                                    Classes.user-message="{Binding IsUser}"
                                    HorizontalAlignment="{Binding HorizontalAlignment}"
                                    MaxWidth="600"
                                    Margin="0,4">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="{Binding Role}"
                                               Classes="caption"
                                               FontWeight="SemiBold" />
                                    <SelectableTextBlock Text="{Binding Content}"
                                               Classes="body"
                                               TextWrapping="Wrap" />
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Loading Indicator -->
            <Border Grid.Row="1"
                    IsVisible="{Binding IsLoading}"
                    VerticalAlignment="Bottom"
                    HorizontalAlignment="Left"
                    Margin="20,0,0,20"
                    Background="{DynamicResource CardBrush}"
                    CornerRadius="12"
                    Padding="16,10">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="AI is thinking..."
                               Classes="caption"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Border>

            <!-- Input Area -->
            <Border Grid.Row="2"
                    Background="{DynamicResource SurfaceBrush}"
                    Padding="20,16"
                    BorderThickness="0,1,0,0"
                    BorderBrush="{DynamicResource CardBrush}">
                <Grid ColumnDefinitions="*, Auto">
                    <TextBox Grid.Column="0"
                             Classes="chat-input"
                             Text="{Binding InputMessage}"
                             Watermark="Type your message here..."
                             AcceptsReturn="True"
                             MaxHeight="120"
                             TextWrapping="Wrap"
                             IsEnabled="{Binding !IsLoading}"
                             KeyDown="InputTextBox_KeyDown" />
                    <Button Grid.Column="1"
                            Classes="primary"
                            Margin="12,0,0,0"
                            Command="{Binding SendMessageCommand}"
                            IsEnabled="{Binding CanSendMessage}"
                            VerticalAlignment="Bottom">
                        <TextBlock Text="Send" />
                    </Button>
                </Grid>
            </Border>
        </Grid>

        <!-- Info Overlay -->
        <Border Grid.ColumnSpan="2"
                IsVisible="{Binding IsInfoVisible}"
                Background="#80000000">
            <Border Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="16"
                    Padding="32"
                    MaxWidth="600"
                    MaxHeight="500"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <ScrollViewer>
                    <StackPanel Spacing="20">
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Text="How to Get Ollama"
                                       Classes="title" />
                            <Button Grid.Column="1"
                                    Classes="icon"
                                    Command="{Binding CloseInfoCommand}">
                                <TextBlock Text="X" FontSize="16" FontWeight="Bold" />
                            </Button>
                        </Grid>

                        <TextBlock TextWrapping="Wrap"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   LineHeight="22">
                            Ollama is a lightweight framework for running large language models locally on your machine.
                            It's free, open-source, and keeps your data private.
                        </TextBlock>

                        <Separator />

                        <StackPanel Spacing="16">
                            <TextBlock Text="Installation Steps:" Classes="heading" />

                            <StackPanel Spacing="12">
                                <Border Background="{DynamicResource CardBrush}"
                                        CornerRadius="8"
                                        Padding="16">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="1. Download Ollama" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />
                                        <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}">
                                            Visit https://ollama.ai and download the installer for your operating system (Windows, macOS, or Linux).
                                        </TextBlock>
                                    </StackPanel>
                                </Border>

                                <Border Background="{DynamicResource CardBrush}"
                                        CornerRadius="8"
                                        Padding="16">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="2. Install and Run" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />
                                        <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}">
                                            Run the installer and follow the prompts. Once installed, Ollama will run as a service on your machine.
                                        </TextBlock>
                                    </StackPanel>
                                </Border>

                                <Border Background="{DynamicResource CardBrush}"
                                        CornerRadius="8"
                                        Padding="16">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="3. Pull a Model" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />
                                        <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}">
                                            Open a terminal and run: ollama pull llama3.2
                                        </TextBlock>
                                        <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12">
                                            Other popular models: mistral, codellama, phi3, gemma2
                                        </TextBlock>
                                    </StackPanel>
                                </Border>

                                <Border Background="{DynamicResource CardBrush}"
                                        CornerRadius="8"
                                        Padding="16">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="4. Start Chatting!" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" />
                                        <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}">
                                            Ollama runs on http://localhost:11434 by default. GuyOllamaAI will automatically connect to it!
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </StackPanel>

                        <Separator />

                        <StackPanel Spacing="8">
                            <TextBlock Text="Server URL (Advanced):" Classes="caption" />
                            <Grid ColumnDefinitions="*, Auto">
                                <TextBox Text="{Binding ServerUrl}"
                                         Classes="chat-input"
                                         Watermark="http://localhost:11434" />
                                <Button Grid.Column="1"
                                        Classes="primary"
                                        Margin="8,0,0,0"
                                        Command="{Binding TestConnectionCommand}">
                                    <TextBlock Text="Test" />
                                </Button>
                            </Grid>
                        </StackPanel>

                        <Button Classes="primary"
                                HorizontalAlignment="Stretch"
                                Command="{Binding CloseInfoCommand}">
                            <TextBlock Text="Got it!" />
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Border>

        <!-- Settings Overlay -->
        <Border Grid.ColumnSpan="2"
                IsVisible="{Binding IsSettingsVisible}"
                Background="#80000000">
            <Border Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="16"
                    Padding="32"
                    MaxWidth="500"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center">
                <StackPanel Spacing="20">
                    <Grid ColumnDefinitions="*, Auto">
                        <TextBlock Text="Settings"
                                   Classes="title" />
                        <Button Grid.Column="1"
                                Classes="icon"
                                Command="{Binding CloseSettingsCommand}">
                            <TextBlock Text="X" FontSize="16" FontWeight="Bold" />
                        </Button>
                    </Grid>

                    <Separator />

                    <StackPanel Spacing="12">
                        <TextBlock Text="Ollama Server URL:" Classes="caption" />
                        <TextBox Text="{Binding ServerUrl}"
                                 Classes="chat-input"
                                 Watermark="http://localhost:11434" />
                    </StackPanel>

                    <StackPanel Spacing="8">
                        <TextBlock Text="Connection Status:" Classes="caption" />
                        <Border Background="{DynamicResource CardBrush}"
                                CornerRadius="8"
                                Padding="12">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Ellipse Width="10" Height="10"
                                         Fill="{Binding ConnectionStatusColor}" />
                                <TextBlock Text="{Binding ConnectionStatus}"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <Grid ColumnDefinitions="*, *" Margin="0,8,0,0">
                        <Button Grid.Column="0"
                                Classes="secondary"
                                HorizontalAlignment="Stretch"
                                Margin="0,0,4,0"
                                Command="{Binding TestConnectionCommand}">
                            <TextBlock Text="Test Connection" />
                        </Button>
                        <Button Grid.Column="1"
                                Classes="primary"
                                HorizontalAlignment="Stretch"
                                Margin="4,0,0,0"
                                Command="{Binding SaveSettingsCommand}">
                            <TextBlock Text="Save" />
                        </Button>
                    </Grid>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</Window>
